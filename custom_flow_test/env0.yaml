version: 2

deploy:
  steps:
    setupVariables:
      after:
        - name: Add Role
          run: |
            echo "ENV0_AWS_ROLE_ARN=arn:aws:iam::326535729404:role/env0-acme-assume-role" >> $ENV0_ENV
            echo "ENV0_AWS_ROLE_EXTERNAL_ID=bde19c6d-d0dc-4b11-a951-8f43fe49db92" >> $ENV0_ENV
        - name: CHECK ROLE
          run: |
            echo $ENV0_AWS_ROLE_ARN
            echo $ENV0_AWS_ROLE_EXTERNAL_ID
            cat ~/.aws/cli/cache
        - name: Assume Role
          run: |
            export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
            $(aws sts assume-role \
            --role-arn arn:aws:iam::326535729404:role/env0-acme-assume-role \
            --external-id bde19c6d-d0dc-4b11-a951-8f43fe49db92 \
            --role-session-name MySessionName \
            --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
            --output text))
        - name: TEST 2 
          run: |
            aws sts get-caller-identity
